
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Jerome Boyer">
      
      
      
        <link rel="prev" href="../websocket-lambda/">
      
      
        <link rel="next" href="../dev_ops/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.17">
    
    
      
        <title>Security - Lambda deeper studies</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.bcfcd587.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#security-in-lambda-context" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Lambda deeper studies" class="md-header__button md-logo" aria-label="Lambda deeper studies" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Lambda deeper studies
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Security
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/jbcodeforce/autonomous-car-mgr.git" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Lambda deeper studies" class="md-nav__button md-logo" aria-label="Lambda deeper studies" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Lambda deeper studies
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jbcodeforce/autonomous-car-mgr.git" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Architecture
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../scaling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scaling
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../websocket-lambda/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    WebSocket
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Security
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Security
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#shared-responsibility" class="md-nav__link">
    <span class="md-ellipsis">
      Shared responsibility
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-different-security-actors-in-lambda-context" class="md-nav__link">
    <span class="md-ellipsis">
      The different security actors in Lambda context
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#policies-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Policies best practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Policies best practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-of-ensuring-least-privilege" class="md-nav__link">
    <span class="md-ellipsis">
      Example of ensuring least privilege
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#secops-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      SecOps considerations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SecOps considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#environment-variables" class="md-nav__link">
    <span class="md-ellipsis">
      Environment Variables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secrets-in-aws-secrets" class="md-nav__link">
    <span class="md-ellipsis">
      Secrets in AWS Secrets
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#access-to-vpc-resources" class="md-nav__link">
    <span class="md-ellipsis">
      Access to VPC resources
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../dev_ops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DevOps
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../cost/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cost
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#shared-responsibility" class="md-nav__link">
    <span class="md-ellipsis">
      Shared responsibility
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-different-security-actors-in-lambda-context" class="md-nav__link">
    <span class="md-ellipsis">
      The different security actors in Lambda context
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#policies-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Policies best practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Policies best practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-of-ensuring-least-privilege" class="md-nav__link">
    <span class="md-ellipsis">
      Example of ensuring least privilege
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#secops-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      SecOps considerations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SecOps considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#environment-variables" class="md-nav__link">
    <span class="md-ellipsis">
      Environment Variables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secrets-in-aws-secrets" class="md-nav__link">
    <span class="md-ellipsis">
      Secrets in AWS Secrets
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#access-to-vpc-resources" class="md-nav__link">
    <span class="md-ellipsis">
      Access to VPC resources
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="security-in-lambda-context">Security in Lambda context<a class="headerlink" href="#security-in-lambda-context" title="Permanent link">&para;</a></h1>
<p>As a managed service, AWS manages the underlying infrastructure and foundation services, the operating system, and the application platform. Developers need to ensure code, libraries, configuration, IAM are well set.</p>
<h2 id="shared-responsibility">Shared responsibility<a class="headerlink" href="#shared-responsibility" title="Permanent link">&para;</a></h2>
<p>With the AWS Cloud, managing security and compliance is a <a href="https://aws.amazon.com/compliance/shared-responsibility-model/">shared responsibility</a> between AWS and the customer:</p>
<ul>
<li><a href="https://aws.amazon.com/security/">AWS is responsible of security <strong>of</strong> the cloud</a> and offers the most flexible and secure cloud computing environment available today. AWS is responsible for patching their managed services and infrastructure security.</li>
<li>Customers are responsible for the security <strong>in</strong> the cloud: secure workloads and applications that are deployed onto the cloud. When using EC2, we are responsible to patch OS for security (but AWS helps by providing patched AMIs, or tools such as <a href="https://aws.amazon.com/systems-manager">Systems Manager</a>, or <a href="https://aws.amazon.com/inspector/">Inspector</a> for continuous vulnerability testing).</li>
</ul>
<h2 id="the-different-security-actors-in-lambda-context">The different security actors in Lambda context<a class="headerlink" href="#the-different-security-actors-in-lambda-context" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>A developer who need to access Lambda Management Console, deploy code, review logs. The AWS account IAM administrator needs to authorize access via user group and IAM policies.</p>
</li>
<li>
<p>Authenticated "user" includes the AWS account root user, an IAM user (developer), or an assumed IAM role. It is possible to use <a href="https://docs.aws.amazon.com/lambda/latest/dg/security-iam.html#security_iam_authentication">federated identity</a> to authenticate users.</p>
</li>
<li>
<p>The client applications calling the Lambda function: the control is done via <strong>resource policies</strong>. Resource policies are created when we add a trigger to a Lambda function, or defined when specifying a "push" event source such as Amazon API Gateway. Policy allows the event source to take the <code>lambda:InvokeFunction</code> action. Restrict access to only required principals.</p>
</li>
<li>The code within the lambda function to act upon other services is controlled via IAM <a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-permissions.html"><strong>execution role</strong></a>. This role  must include a trust policy that allows Lambda to “AssumeRole” so that it can take that action for another service.</li>
</ol>
<h2 id="policies-best-practices">Policies best practices<a class="headerlink" href="#policies-best-practices" title="Permanent link">&para;</a></h2>
<p>See <a href="https://docs.aws.amazon.com/lambda/latest/dg/security_iam_id-based-policy-examples.html#security_iam_service-with-iam-policy-best-practices">product documentation</a> and <a href="https://us-west-2.console.aws.amazon.com/access-analyzer/home?region=us-west-2#/">IAM Access Analyzer</a> tool to validate your own policy.</p>
<p>For execution role consider the AWS managed policies such as <code>AWSLambdaBasicExecutionRole</code>, <code>CloudWatchLambdaInsightsExecutionRolePolicy</code> and <code>AWSXRayDaemonWriteAccess</code>.</p>
<p>Use IAM Access Analyzer to generate least-privilege policies based on access activity.</p>
<h3 id="example-of-ensuring-least-privilege"><a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-intro-execution-role.html#permissions-executionrole-least-privilege">Example of ensuring least privilege</a><a class="headerlink" href="#example-of-ensuring-least-privilege" title="Permanent link">&para;</a></h3>
<p>The IAM user guide, <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege">Apply least-privilege permissions  section</a> includes the best practices to get started and reduce the permissions. Start by using the AWS managed policies that grant permissions for many common use cases and then define your own customer managed policies.</p>
<p>Implement fine-grained access control using IAM policies. For example, use conditions to restrict which functions can invoke other functions.</p>
<p>The CDK code for Lambda function to access DynamoDB table is</p>
<div class="highlight"><pre><span></span><code><span class="n">carTable</span><span class="o">.</span><span class="n">grant_read_write_data</span><span class="p">(</span><span class="n">acm_lambda</span><span class="p">)</span>
</code></pre></div>
<p>And generates the following policy:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&quot;Statement&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;Action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;dynamodb:BatchGetItem&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;dynamodb:BatchWriteItem&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;dynamodb:ConditionCheckItem&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;dynamodb:DeleteItem&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;dynamodb:DescribeTable&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;dynamodb:GetItem&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;dynamodb:GetRecords&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;dynamodb:GetShardIterator&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;dynamodb:PutItem&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;dynamodb:Query&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;dynamodb:Scan&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;dynamodb:UpdateItem&quot;</span>
<span class="w">        </span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;Resource&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:dynamodb:us-west-2:927698749254:table/acm_cars&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;Effect&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span>
<span class="w">    </span><span class="p">}],</span>
</code></pre></div>
<p>See <a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-api-permissions-ref.html">other examples</a> from product documentation.</p>
<p>If developer needs to be more restrictive, it is possible to define custom policy and attach to a role used by the Lambda function. CDK, CloudFormation or SAM offer such constructs.</p>
<div class="highlight"><pre><span></span><code><span class="n">sm_role</span><span class="o">.</span><span class="n">add_managed_policy</span><span class="p">(</span><span class="n">iam</span><span class="o">.</span><span class="n">ManagedPolicy</span><span class="o">.</span><span class="n">from_aws_managed_policy_name</span><span class="p">(</span><span class="s2">&quot;service-role/AWSLambdaBasicExecutionRole&quot;</span><span class="p">))</span>
<span class="n">sm_role</span><span class="o">.</span><span class="n">add_managed_policy</span><span class="p">(</span><span class="n">iam</span><span class="o">.</span><span class="n">ManagedPolicy</span><span class="o">.</span><span class="n">from_aws_managed_policy_name</span><span class="p">(</span><span class="s2">&quot;AWSXRayDaemonWriteAccess&quot;</span><span class="p">))</span>
<span class="n">sm_role</span><span class="o">.</span><span class="n">add_managed_policy</span><span class="p">(</span><span class="n">iam</span><span class="o">.</span><span class="n">ManagedPolicy</span><span class="o">.</span><span class="n">from_aws_managed_policy_name</span><span class="p">(</span><span class="s2">&quot;service-role/AWSLambdaVPCAccessExecutionRole&quot;</span><span class="p">))</span>
</code></pre></div>
<h2 id="secops-considerations">SecOps considerations<a class="headerlink" href="#secops-considerations" title="Permanent link">&para;</a></h2>
<p>As a DevOps consider the followings:</p>
<ul>
<li>the <a href="https://docs.aws.amazon.com/lambda/latest/dg/security-dataprotection.html">Data privacy</a> with encryption at rest with customer managed Key.</li>
<li>Lambda only supports secure connections over HTTPS (TLS1.2)</li>
<li>Environment variables are secured by encryption using a Lambda-managed KMS key (named <code>aws/lambda</code>). The <code>CreateFunction</code> API or <code>UpdateFunctionConfiguration</code> may use KMS Keys.</li>
<li>Do not store sensitive information inside a Lambda function.</li>
<li>Monitor and log function execution using services like AWS CloudWatch Logs, X-Ray, and GuardDuty. AWS X-Ray also encrypts data by default.</li>
<li>Run on EC2 with Nitro System for better security isolation.</li>
<li>Monitor access and permissions using services like AWS CloudTrail and AWS Config. These provide visibility into who/what is invoking your functions.</li>
<li>Code releases go through security review and penetration testing.</li>
<li>Lambda provides a code signing feature to ensure only trusted code runs in the Lambda function.</li>
<li>Use AWS WAF with API Gateway or CloudFront to filter requests to your functions based on IP addresses or request attributes.</li>
<li>Each Lambda exec environment includes a writeable /tmp folder: files written within it, remain for the lifetime of the execution environment.</li>
</ul>
<h3 id="environment-variables">Environment Variables<a class="headerlink" href="#environment-variables" title="Permanent link">&para;</a></h3>
<p><a href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-envvars.html">Environment Variables in Lambda</a> helps to avoid putting credentials, endpoints URL, etc, in code. Infrastructure as code can help linking created resource, like a dynamoDB table with a lambda function.</p>
<div class="highlight"><pre><span></span><code><span class="err">acm_lambda</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">aws_lambda.Fu</span><span class="kc">n</span><span class="err">c</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">(sel</span><span class="kc">f</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;CarMgrService&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="err">ru</span><span class="kc">nt</span><span class="err">ime=aws_lambda.Ru</span><span class="kc">nt</span><span class="err">ime.PYTHON_</span><span class="mi">3</span><span class="err">_</span><span class="mi">11</span><span class="p">,</span>
<span class="w">            </span><span class="kc">fun</span><span class="err">c</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="err">_</span><span class="kc">na</span><span class="err">me=</span><span class="w"> </span><span class="s2">&quot;CarMgrService&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="err">e</span><span class="kc">n</span><span class="err">viro</span><span class="kc">n</span><span class="err">me</span><span class="kc">nt</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;CAR_EVENT_BUS&quot;</span><span class="p">:</span><span class="err">carEve</span><span class="kc">nt</span><span class="err">Bus.eve</span><span class="kc">nt</span><span class="err">_bus_</span><span class="kc">na</span><span class="err">me</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;CAR_TABLE_NAME&quot;</span><span class="p">:</span><span class="err">carTable.</span><span class="kc">ta</span><span class="err">ble_</span><span class="kc">na</span><span class="err">me</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;POWERTOOLS_SERVICE_NAME&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;CarManager&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;POWERTOOLS_METRICS_NAMESPACE&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;CarManager&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;POWERTOOLS_LOG_LEVEL&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="p">},</span>
</code></pre></div>
<p>When you publish a version, the environment variables are locked for that version.</p>
<p>Lambda runtimes set several environment variables (AWS_REGION, AWS_EXECUTION_ENV...) during initialization. Most of the environment variables provide information about the function or runtime.</p>
<p>Environment variables can be encrypted using server-side encryption with an AWS KMS key. When using default key there is no need to get access permission, while when using customer managed key, Lambda needs grant access to on the key</p>
<h3 id="secrets-in-aws-secrets">Secrets in AWS Secrets<a class="headerlink" href="#secrets-in-aws-secrets" title="Permanent link">&para;</a></h3>
<p>Lambda can access AWS Secrets and then uses the secret to connect to a service, a private resource or an API.</p>
<ol>
<li>
<p>Create a secret using AWS CLI</p>
<div class="highlight"><pre><span></span><code><span class="nv">DB_PASSWORD</span><span class="o">=</span><span class="k">$(</span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/random<span class="w"> </span><span class="nv">bs</span><span class="o">=</span><span class="m">8</span><span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>od<span class="w"> </span>-An<span class="w"> </span>-tx1<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39; \t\n&#39;</span><span class="k">)</span>
aws<span class="w"> </span>secretsmanager<span class="w"> </span>create-secret<span class="w"> </span>--name<span class="w"> </span>rds-postgres-admin<span class="w"> </span>--description<span class="w"> </span><span class="s2">&quot;database password&quot;</span><span class="w"> </span>--secret-string<span class="w"> </span><span class="s2">&quot;{\&quot;username\&quot;:\&quot;postgres\&quot;,\&quot;password\&quot;:\&quot;</span><span class="nv">$DB_PASSWORD</span><span class="s2">\&quot;}&quot;</span>
</code></pre></div>
</li>
<li>
<p>Or via CDK</p>
<div class="highlight"><pre><span></span><code><span class="n">secrets</span><span class="o">=</span><span class="n">aws_secretsmanager</span><span class="o">.</span><span class="n">Secret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                              <span class="s2">&quot;ACMsecrets&quot;</span><span class="p">,</span>
                            <span class="n">secret_name</span><span class="o">=</span><span class="n">DEFAULT_SECRET_NAME</span><span class="p">,</span>
                            <span class="n">generate_secret_string</span><span class="o">=</span><span class="n">aws_secretsmanager</span><span class="o">.</span><span class="n">SecretStringGenerator</span><span class="p">(</span>
                                <span class="n">secret_string_template</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;postgres&quot;</span><span class="p">}),</span>
                                <span class="n">generate_string_key</span><span class="o">=</span><span class="s2">&quot;password&quot;</span><span class="p">,</span>
                                <span class="n">exclude_characters</span><span class="o">=</span><span class="s2">&quot;/@&quot;</span>
                            <span class="p">))</span>
<span class="n">secrets</span><span class="o">.</span><span class="n">grant_read</span><span class="p">(</span><span class="n">grantee</span><span class="o">=</span><span class="n">acm_lambda</span><span class="p">)</span>
</code></pre></div>
</li>
<li>
<p>Pass the secret name as environment variable to the Lambda function</p>
</li>
<li>
<p>In function code, access Secret Manager using SDK</p>
<div class="highlight"><pre><span></span><code><span class="n">secret_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;secret_name&quot;</span><span class="p">)</span>
<span class="n">secret_client</span><span class="o">=</span><span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;secretsmanager&quot;</span><span class="p">)</span>
<span class="n">secret_value_response</span> <span class="o">=</span> <span class="n">secret_client</span><span class="o">.</span><span class="n">get_secret_value</span><span class="p">(</span>
        <span class="n">SecretId</span><span class="o">=</span><span class="n">secret_name</span>
    <span class="p">)</span>
<span class="n">username</span><span class="o">=</span><span class="n">secret_value_response</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
</code></pre></div>
</li>
</ol>
<h2 id="access-to-vpc-resources">Access to VPC resources<a class="headerlink" href="#access-to-vpc-resources" title="Permanent link">&para;</a></h2>
<p>Lambda function can access resources inside a private VPC. Developer needs to provide additional VPC-specific configuration information that includes VPC subnet IDs and security group IDs and the <code>AWSLambdaVPCAccessExecutionRole</code> policy. AWS Lambda uses this information to set up elastic network interfaces (ENIs), for each subnet, that enable the function to connect securely to other resources in the VPC.</p>
<p><img alt="" src="../diagrams/vpc-lambda.drawio.png" /></p>
<p><em>ENI represents a virtual network card</em></p>
<p>As Lambda function always runs inside a VPC owned by the Lambda service, the function accesses resources in our VPC using a <a href="https://docs.aws.amazon.com/lambda/latest/dg/foundation-networking.html#foundation-nw-eni">Hyperplane ENI</a>. Hyperplane ENIs provide NAT capabilities from the Lambda VPC to our account VPC using VPC-to-VPC NAT (V2N).</p>
<p>If it runs out of IP@ then we will have EC2 error types like <code>EC2ThrottledException</code> and the function will not scale. So be sure to have multiple AZ/ subnets and enough IP@.</p>
<p>For the function to access the internet, route outbound traffic to a NAT gateway in one public subnet in our VPC.</p>
<p>To establish a private connection between the VPC and Lambda, create an interface VPC endpoint (using AWS PrivateLink). Traffic between the VPC and Lambda does not leave the AWS network.</p>
<div class="highlight"><pre><span></span><code>aws<span class="w"> </span>ec2<span class="w"> </span>create-vpc-endpoint<span class="w"> </span>--vpc-id<span class="w"> </span>vpc-ec43eb89<span class="w"> </span>--vpc-endpoint-type<span class="w"> </span>Interface<span class="w"> </span>--service-name<span class="w"> </span><span class="se">\</span>
com.amazonaws.us-west-2.lambda<span class="w"> </span>--subnet-id<span class="w"> </span>subnet-abababab<span class="w"> </span>--security-group-id<span class="w"> </span>sg-1a2b3c4d<span class="w">      </span>
</code></pre></div>
<p>Endpoint policy can be attached to the interface endpoint to add more control on which resource inside the VPC can access the lambda function (Principal = user, Allow lambda:InvokeFunction on resource with the function arn).</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../websocket-lambda/" class="md-footer__link md-footer__link--prev" aria-label="Previous: WebSocket">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                WebSocket
              </div>
            </div>
          </a>
        
        
          
          <a href="../dev_ops/" class="md-footer__link md-footer__link--next" aria-label="Next: DevOps">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                DevOps
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.annotate", "content.tooltips", "navigation.instant", "navigation.tracking", "navigation.footer", "navigation.tabs.sticky"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.1e8ae164.min.js"></script>
      
    
  </body>
</html>